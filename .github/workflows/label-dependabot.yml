name: "Label Dependabot PRs"

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch: {}

permissions:
  issues: write
  pull-requests: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Label this Dependabot PR
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            async function addLabelToPr(prNumber) {
              const pr = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
              const author = pr.data.user?.login;
              const labels = pr.data.labels.map(l => l.name);
              if (author === 'dependabot[bot]' && !labels.includes('automerge')) {
                core.info(`Adding label 'automerge' to PR #${prNumber}`);
                await github.rest.issues.addLabels({ owner, repo, issue_number: prNumber, labels: ['automerge'] });
              } else {
                core.info(`PR #${prNumber} is not a Dependabot PR or already labeled`);
              }
            }

            if (context.eventName === 'workflow_dispatch') {
              core.info('Listing open PRs and labeling Dependabot ones');
              const pulls = await github.paginate(github.rest.pulls.list, { owner, repo, state: 'open', per_page: 100 });
              for (const pr of pulls) {
                if (pr.user?.login === 'dependabot[bot]') {
                  const labels = pr.labels.map(l => l.name);
                  if (!labels.includes('automerge')) {
                    core.info(`Labeling PR #${pr.number}`);
                    await github.rest.issues.addLabels({ owner, repo, issue_number: pr.number, labels: ['automerge'] });
                  }
                }
              }
            } else {
              const prNumber = context.payload.pull_request.number;
              await addLabelToPr(prNumber);
            }
