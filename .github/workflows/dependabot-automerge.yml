name: "Dependabot Auto-merge"

# This workflow listens for completed runs of the canonical `CI` workflow.
# When the `CI` workflow completes successfully it finds any open PR(s)
# that correspond to the run's head SHA and enables auto-merge for PRs that
# are authored by dependabot[bot] or that have the `automerge` label.

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: read
  checks: read
  pull-requests: write

jobs:
  enable-automerge:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Find PRs for workflow run head SHA
        id: find_prs
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const headSha = context.payload.workflow_run.head_sha;
            core.info(`Looking up PRs associated with commit ${headSha}`);
            // Finds PRs associated with the commit (may return 0 or more)
            const result = await github.rest.repos.listPullRequestsAssociatedWithCommit({ owner, repo, commit_sha: headSha });
            const openPrs = result.data.filter(p => p.state === 'open');
            const prNumbers = openPrs.map(p => p.number);
            core.info(`Found PRs: ${prNumbers.join(', ')}`);
            core.setOutput('prNumbers', prNumbers.join(','));

      - name: Enable auto-merge for matching Dependabot / `automerge` PRs
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prListRaw = '${{ steps.find_prs.outputs.prNumbers }}';
            const prNums = prListRaw ? prListRaw.split(',').map(n => parseInt(n, 10)).filter(Boolean) : [];
            if (prNums.length === 0) {
              core.info('No open PRs found for this run SHA. Nothing to do.');
              return;
            }
            for (const prNumber of prNums) {
              const pr = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
              const author = pr.data.user?.login;
              const labels = pr.data.labels.map(l => l.name);
              if (author === 'dependabot[bot]' || labels.includes('automerge')) {
                core.info(`Enabling auto-merge for PR #${prNumber}`);
                await github.rest.pulls.enableAutoMerge({ owner, repo, pull_number: prNumber, merge_method: 'squash' });
              } else {
                core.info(`Skipping PR #${prNumber} (author=${author} labels=${labels.join('|')})`);
              }
            }
