name: "Dependabot Auto-merge"

# Automatically enable auto-merge for Dependabot PRs when CI passes.
# This workflow runs after the CI workflow completes successfully.

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    name: "Auto-merge Dependabot PRs"
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge for Dependabot PRs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const headSha = context.payload.workflow_run.head_sha;
            
            core.info(`Looking for PRs with commit ${headSha}`);
            
            // Find PRs associated with this commit
            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner,
              repo,
              commit_sha: headSha
            });
            
            const openPrs = prs.filter(pr => pr.state === 'open');
            core.info(`Found ${openPrs.length} open PR(s)`);
            
            for (const pr of openPrs) {
              const author = pr.user?.login;
              const labels = pr.labels.map(l => l.name);
              
              // Auto-merge if created by Dependabot or has 'automerge' label
              if (author === 'dependabot[bot]' || labels.includes('automerge')) {
                core.info(`Enabling auto-merge for PR #${pr.number} by ${author}`);
                try {
                  await github.graphql(`
                    mutation($prId: ID!) {
                      enablePullRequestAutoMerge(input: {
                        pullRequestId: $prId,
                        mergeMethod: SQUASH
                      }) {
                        pullRequest {
                          number
                          autoMergeRequest {
                            enabledAt
                          }
                        }
                      }
                    }
                  `, {
                    prId: pr.node_id
                  });
                  core.info(`âœ“ Auto-merge enabled for PR #${pr.number}`);
                } catch (error) {
                  core.warning(`Failed to enable auto-merge for PR #${pr.number}: ${error.message}`);
                }
              } else {
                core.info(`Skipping PR #${pr.number} (author: ${author}, labels: ${labels.join(', ') || 'none'})`);
              }
            }
